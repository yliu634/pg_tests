SET
DROP TABLE
DROP ROLE
CREATE ROLE
 max_prepared_transactions 
---------------------------
 20
(1 row)

 global_id | owner | database 
-----------+-------+----------
(0 rows)

 gid | owner | database 
-----+-------+----------
(0 rows)

CREATE TABLE
GRANT
BEGIN
 a 
---
(0 rows)

PREPARE TRANSACTION
 global_id | owner |          database           
-----------+-------+-----------------------------
 read-only | pan   | crdb_tests_two_phase_commit
(1 row)

    gid    | owner |          database           
-----------+-------+-----------------------------
 read-only | pan   | crdb_tests_two_phase_commit
(1 row)

COMMIT PREPARED
 global_id 
-----------
(0 rows)

BEGIN
 a 
---
(0 rows)

PREPARE TRANSACTION
ROLLBACK PREPARED
BEGIN
INSERT 0 1
PREPARE TRANSACTION
 global_id  
------------
 read-write
(1 row)

COMMIT PREPARED
 a 
---
 1
(1 row)

BEGIN
INSERT 0 1
PREPARE TRANSACTION
ROLLBACK PREPARED
 a 
---
 1
(1 row)

 global_id 
-----------
(0 rows)

BEGIN
INSERT 0 1
PREPARE TRANSACTION
BEGIN
INSERT 0 1
psql:compatible/two_phase_commit.sql:129: ERROR:  transaction identifier "duplicate" is already in use
psql:compatible/two_phase_commit.sql:131: WARNING:  there is no transaction in progress
ROLLBACK
COMMIT PREPARED
 a 
---
 1
 2
(2 rows)

BEGIN
psql:compatible/two_phase_commit.sql:148: ERROR:  transaction identifier "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" is too long
psql:compatible/two_phase_commit.sql:150: WARNING:  there is no transaction in progress
ROLLBACK
BEGIN
PREPARE TRANSACTION
                                                                                                global_id                                                                                                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
(1 row)

ROLLBACK PREPARED
BEGIN
psql:compatible/two_phase_commit.sql:173: ERROR:  division by zero
ROLLBACK
psql:compatible/two_phase_commit.sql:177: WARNING:  there is no transaction in progress
ROLLBACK
 global_id | owner | database 
-----------+-------+----------
(0 rows)

psql:compatible/two_phase_commit.sql:196: WARNING:  there is no transaction in progress
ROLLBACK
psql:compatible/two_phase_commit.sql:205: WARNING:  there is no transaction in progress
ROLLBACK
BEGIN
psql:compatible/two_phase_commit.sql:214: ERROR:  COMMIT PREPARED cannot run inside a transaction block
ROLLBACK
BEGIN
psql:compatible/two_phase_commit.sql:224: ERROR:  ROLLBACK PREPARED cannot run inside a transaction block
ROLLBACK
psql:compatible/two_phase_commit.sql:234: ERROR:  prepared transaction with identifier "unknown" does not exist
psql:compatible/two_phase_commit.sql:240: ERROR:  prepared transaction with identifier "unknown" does not exist
BEGIN
INSERT 0 1
PREPARE TRANSACTION
    global_id    | owner |          database           
-----------------+-------+-----------------------------
 read-write-root | pan   | crdb_tests_two_phase_commit
(1 row)

SET
psql:compatible/two_phase_commit.sql:261: ERROR:  permission denied to finish prepared transaction
HINT:  Must be superuser or the user that prepared the transaction.
BEGIN
INSERT 0 1
PREPARE TRANSACTION
      global_id      |     owner     |          database           
---------------------+---------------+-----------------------------
 read-write-root     | pan           | crdb_tests_two_phase_commit
 read-write-testuser | tpct_testuser | crdb_tests_two_phase_commit
(2 rows)

psql:compatible/two_phase_commit.sql:281: ERROR:  cannot delete from view "pg_prepared_xacts"
DETAIL:  Views that do not select from a single table or view are not automatically updatable.
HINT:  To enable deleting from the view, provide an INSTEAD OF DELETE trigger or an unconditional ON DELETE DO INSTEAD rule.
RESET
      global_id      |     owner     |          database           
---------------------+---------------+-----------------------------
 read-write-root     | pan           | crdb_tests_two_phase_commit
 read-write-testuser | tpct_testuser | crdb_tests_two_phase_commit
(2 rows)

         gid         |     owner     |          database           
---------------------+---------------+-----------------------------
 read-write-root     | pan           | crdb_tests_two_phase_commit
 read-write-testuser | tpct_testuser | crdb_tests_two_phase_commit
(2 rows)

ROLLBACK PREPARED
ROLLBACK PREPARED
 global_id | owner | database 
-----------+-------+----------
(0 rows)

DROP TABLE
DROP ROLE
RESET
